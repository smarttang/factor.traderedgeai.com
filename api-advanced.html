<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API 文档 · 进阶版 | TraderEdgeAIFactor</title>
  <meta name="description" content="TraderEdgAIFactor.dll 进阶版 API：面向高端技术专家，完整入参/出参说明与详细对接代码，减少对接问题与客服咨询。">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
  <style>
    /* 复用 api.html 的样式，此处仅覆盖进阶版特有 */
    body { font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #fff; color: #202020; }
    :root { --bg: #fff; --bg-alt: #fafafa; --text: #202020; --text-muted: #5c5c5c; --green: #4da29e; --green-dark: #3d8582; --gray-pill: #f0f0f0; --gray-border: #e8e8e8; --terminal-bg: #1e1e1e; --radius: 12px; --radius-sm: 8px; }
    .api-doc-wrap { display: grid; grid-template-columns: 220px 1fr; max-width: 1400px; margin: 0 auto; min-height: calc(100vh - 56px); }
    .api-sidebar { position: sticky; top: 56px; height: calc(100vh - 56px); overflow-y: auto; padding: 1.25rem; border-right: 1px solid var(--gray-border); background: var(--bg-alt); }
    .api-toc { display: flex; flex-direction: column; gap: 0.25rem; }
    .api-toc a { display: block; padding: 0.4rem 0.75rem; color: var(--text-muted); text-decoration: none; font-size: 0.875rem; border-radius: var(--radius-sm); border-left: 2px solid transparent; }
    .api-toc a:hover, .api-toc a.active { color: var(--green); background: rgba(77,162,158,0.08); border-left-color: var(--green); }
    .api-main { padding: 1.5rem 2rem 3rem; min-width: 0; }
    .sec { margin-bottom: 2.5rem; }
    .sec h2 { font-size: 1.35rem; font-weight: 700; margin: 2rem 0 0.75rem; padding-bottom: 0.35rem; border-bottom: 1px solid var(--gray-border); }
    .sec h2:first-child { margin-top: 0; }
    .sec h3 { font-size: 1.05rem; font-weight: 600; margin: 1.5rem 0 0.5rem; color: var(--text-muted); }
    .api-block { background: var(--bg-alt); border: 1px solid var(--gray-border); border-left: 3px solid var(--green); border-radius: var(--radius-sm); padding: 1rem 1.25rem; margin-bottom: 1rem; }
    .api-name { font-weight: 600; color: var(--green); font-size: 1.05rem; margin-bottom: 0.35rem; }
    .api-sig { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--text); background: rgba(0,0,0,0.03); padding: 0.5rem 0.75rem; border-radius: 4px; overflow-x: auto; margin: 0.5rem 0; }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin: 0.5rem 0 1rem; }
    th, td { text-align: left; padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--gray-border); }
    th { color: var(--text-muted); font-weight: 500; }
    .ret { color: var(--green); }
    .note { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem; }
    /* 行内 code：覆盖 Prism 黑色背景，仅加深加粗无背景 */
    code, :not(pre) > code, p code, li code, td code, th code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9em;
      font-weight: 600;
      color: var(--text) !important;
      padding: 0;
      background: transparent !important;
      border: none !important;
    }
    .api-example pre code,
    .api-example pre code[class*="language-"] { background: transparent !important; border: none !important; padding: 0 !important; font-size: inherit; font-weight: 400 !important; color: inherit !important; }
    .api-example .token { text-decoration: none !important; }
    .struct-def { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; font-weight: 600; color: var(--text); background: rgba(0,0,0,0.03); padding: 0.75rem 1rem; border-radius: 4px; white-space: pre; overflow-x: auto; margin: 0.5rem 0; }
    .lang-en .struct-def[data-lang="zh"] { display: none !important; }
    .lang-en .struct-def[data-lang="en"] { display: block !important; }
    .lang-zh .struct-def[data-lang="en"] { display: none !important; }
    .lang-zh .struct-def[data-lang="zh"] { display: block !important; }
    .api-example pre[data-lang] { display: block; }
    .lang-en .api-example pre[data-lang="zh"] { display: none !important; }
    .lang-en .api-example pre[data-lang="en"] { display: block !important; }
    .lang-zh .api-example pre[data-lang="en"] { display: none !important; }
    .lang-zh .api-example pre[data-lang="zh"] { display: block !important; }
    .api-example { margin-top: 0.75rem; }
    .api-example-title { font-size: 0.8rem; font-weight: 600; color: var(--text-muted); margin-bottom: 0.35rem; }
    .api-example pre { font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; background: var(--bg-alt) !important; color: var(--text) !important; padding: 0.75rem 1rem; border-radius: var(--radius-sm); border: 1px solid var(--gray-border); overflow-x: auto; margin: 0 0 0.5rem; white-space: pre-wrap; }
    .api-copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; background: rgba(255,255,255,0.15); color: #d4d4d4; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; cursor: pointer; }
    .api-copy-btn:hover { background: rgba(255,255,255,0.25); }
    .api-copy-btn.copied { background: var(--green); color: #fff; border-color: var(--green); }
    .copy-wrap { position: relative; display: block; }
    .nav { display: flex; align-items: center; justify-content: space-between; height: 56px; padding: 0 1.5rem; border-bottom: 1px solid var(--gray-border); background: var(--bg); position: sticky; top: 0; z-index: 100; }
    .nav-logo { display: flex; align-items: center; text-decoration: none; height: 100%; }
    .nav-logo img { max-height: 28px; }
    .nav-links { display: flex; align-items: center; gap: 2rem; }
    .nav-links a { color: var(--text-muted); text-decoration: none; font-size: 0.9rem; font-weight: 500; }
    .nav-links a:hover { color: var(--text); }
    .nav-links a.nav-current { color: var(--green); font-weight: 600; }
    .nav-cta { padding: 0.5rem 1rem; background: var(--green); color: #fff !important; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.85rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.35rem; }
    .nav-cta:hover { background: var(--green-dark); color: #fff !important; }
    .nav-cta .nav-price { font-weight: 500; font-size: 0.8rem; opacity: 0.95; }
    .nav-cta .nav-price s { color: rgba(255,255,255,0.7); margin-right: 0.25rem; }
    .back-link { display: inline-block; margin-bottom: 1rem; color: var(--green); font-weight: 500; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }
    footer { padding: 2rem 1.5rem; border-top: 1px solid var(--gray-border); background: var(--bg); margin-top: 3rem; }
    .footer-inner { max-width: 1100px; margin: 0 auto; display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1rem; }
    .footer-links { display: flex; gap: 1.5rem; }
    .footer-links a { color: var(--text-muted); text-decoration: none; font-size: 0.85rem; }
    .footer-links a:hover { color: var(--green); }
    .footer-copy { font-size: 0.85rem; color: var(--text-muted); margin: 0; }
    .nav-lang { display: flex; gap: 0.25rem; }
    .nav-lang button { padding: 0.35rem 0.6rem; background: transparent; border: 1px solid var(--gray-border); border-radius: var(--radius-sm); font-size: 0.8rem; cursor: pointer; }
    .nav-lang button.active { color: var(--green); border-color: var(--green); background: rgba(77,162,158,0.08); }
    .nav-toggle { display: none; }
    @media (max-width: 900px) {
      .nav { flex-wrap: wrap; height: auto; min-height: 56px; }
      .nav-links { display: none; order: 10; width: 100%; flex-direction: column; gap: 0; padding: 0.5rem 0 1rem; border-top: 1px solid var(--gray-border); }
      .nav.nav-open .nav-links { display: flex; }
      .nav-toggle { display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; }
      .api-doc-wrap { grid-template-columns: 1fr; }
      .api-sidebar { position: static; max-height: 200px; border-right: none; border-bottom: 1px solid var(--gray-border); }
    }
  </style>
</head>

<body data-i18n-page="api">
  <nav class="nav" id="main-nav">
    <a href="index.html" class="nav-logo"><img src="logo.png" alt="TraderEdgeAIFactor" /></a>
    <div class="nav-links">
      <a href="index.html#how" data-i18n="nav_how">极速上手</a>
      <a href="index.html#features" data-i18n="nav_features">核心能力</a>
      <a href="factors.html" data-i18n="nav_factors">算法因子</a>
      <a href="api.html" class="nav-current" data-i18n="nav_api">API 文档</a>
      <a href="index.html#pricing" data-i18n="nav_pricing">定价</a>
      <a href="index.html#faq" data-i18n="nav_faq">常见问题</a>
      <a href="index.html#pricing" class="nav-cta"><span data-i18n="nav_cta">购买专业版</span> <span class="nav-price" data-i18n="nav_price" data-i18n-html="1"><s>$38/月</s> $30/月</span></a>
    </div>
    <div class="nav-lang">
      <button type="button" class="lang-btn active" data-lang="zh">中文</button>
      <button type="button" class="lang-btn" data-lang="en">EN</button>
    </div>
    <button type="button" class="nav-toggle" id="nav-toggle" aria-label="菜单" data-i18n-attr="aria-label:nav_toggle_aria">☰</button>
  </nav>

  <div class="api-doc-wrap">
    <aside class="api-sidebar">
      <nav class="api-toc" aria-label="文档目录">
        <a href="api.html" class="back-link" data-i18n="back_to_simple">← 返回简单对接</a>
        <a href="#intro" data-i18n="intro_title">进阶版说明</a>
        <a href="#types" data-i18n="adv_types_title">类型与常量</a>
        <a href="#tea" data-i18n="adv_tea_title">标准因子 API (TEA_*)</a>
        <a href="#get-others" data-i18n="adv_get_others_title">其余 Get* API</a>
        <a href="#reduction" data-i18n="adv_reduction_title">削单 API</a>
        <a href="#rsquared" data-i18n="adv_rsquared_title">R² API</a>
      </nav>
    </aside>
    <main class="api-main">
      <!-- 进阶版文档：价值、作用、面向人群 -->
      <section class="sec" id="intro">
        <h2 data-i18n="intro_title">进阶版 API 文档说明</h2>
        <p data-i18n="intro_p1"><strong>本页面向高端技术专家开放。</strong>若你需要在 EA 中深度对接 TraderEdgAIFactor.dll，需要每个 API 的完整入参、出参及参数说明，以及可直接复用的 MQ4/MQ5 代码片段，请以本页为准。</p>
        <p data-i18n="intro_value"><strong>进阶版文档的价值与作用：</strong></p>
        <ul>
          <li data-i18n="intro_li1"><strong>减少对接歧义</strong>：每个 API 均给出入参、出参、参数含义与取值范围，避免因理解偏差导致调用错误。</li>
          <li data-i18n="intro_li2"><strong>提供详细代码片段</strong>：MQ4 与 MQ5 双平台示例、注释与常见坑（如数组顺序、调用顺序、返回值检查），便于直接集成、减少反复试错与客服咨询。</li>
          <li data-i18n="intro_li3"><strong>仅展示对接用 API</strong>：不涉及内部实现与框架，只列出你实际会调用的接口、参数与用法。</li>
        </ul>
        <p data-i18n="intro_link" data-i18n-html="1">简单对接（极简代码与场景说明）请见 <a href="api.html">API 文档（简单版）</a>。</p>
      </section>

      <!-- 类型与常量（对接时用到的常量与结构） -->
      <section class="sec" id="types">
        <h2 data-i18n="adv_types_title">类型与常量</h2>
        <p data-i18n="adv_types_p">对接时用到的因子 ID、Action 常量及标准信号结构（MQ4 中结构体名可能为 TEAStandardSignalData，以头文件为准）。</p>
          <h3 data-i18n="adv_factor_id_h3">因子 ID（统一接口使用）</h3>
          <table>
            <thead><tr><th data-i18n="adv_const">常量</th><th data-i18n="adv_value">值</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody>
              <tr><td><code>TEA_FACTOR_ENTROPY_HEDGE</code></td><td>0</td><td data-i18n="adv_factor_0">EntropyHedge 熵场与对冲矩阵</td></tr>
              <tr><td><code>TEA_FACTOR_TREND_PENALTY</code></td><td>1</td><td data-i18n="adv_factor_1">TrendPenalty 趋势与惩罚</td></tr>
              <tr><td><code>TEA_FACTOR_HEDGE_REGIME</code></td><td>2</td><td data-i18n="adv_factor_2">HedgeRegime 趋势·震荡·刹车</td></tr>
              <tr><td><code>TEA_FACTOR_TREND_STRENGTH_BRAKE</code></td><td>3</td><td data-i18n="adv_factor_3">TrendStrengthBrake 多周期 R²·刹车强度</td></tr>
            </tbody>
          </table>
          <h3 data-i18n="adv_struct_h3">标准信号结构 TEAStandardSignal（MQ4 中为 TEAStandardSignalData）</h3>
          <div class="struct-def" data-lang="zh">struct TEAStandardSignal {
  double direction;   // -1.0 / 0 / +1.0
  double confidence; // 0.0 ~ 1.0
  double strength;  // 0.0 ~ 1.0
  int regime;       // 0=未知, 1=趋势, 2=震荡, -1=高风险
  int action;       // 0=FLAT, 1=LONG, 2=SHORT
  double score;     // 综合评分 0~1
  int valid;        // 1=有效 0=无效
};</div>
          <div class="struct-def" data-lang="en" style="display:none">struct TEAStandardSignal {
  double direction;   // -1.0 / 0 / +1.0
  double confidence; // 0.0 ~ 1.0
  double strength;  // 0.0 ~ 1.0
  int regime;       // 0=unknown, 1=trend, 2=range, -1=high risk
  int action;       // 0=FLAT, 1=LONG, 2=SHORT
  double score;     // composite score 0~1
  int valid;        // 1=valid 0=invalid
};</div>
          <h3 data-i18n="adv_action_h3">Action 枚举</h3>
          <table>
            <thead><tr><th data-i18n="adv_const">常量</th><th data-i18n="adv_value">值</th></tr></thead>
            <tbody>
              <tr><td><code>TEA_ACTION_FLAT</code></td><td>0</td></tr>
              <tr><td><code>TEA_ACTION_LONG</code></td><td>1</td></tr>
              <tr><td><code>TEA_ACTION_SHORT</code></td><td>2</td></tr>
            </tbody>
          </table>
      </section>

      <!-- 标准因子 API (TEA_*)：对接用 API，入参/出参/说明 + 代码片段 -->
      <section class="sec" id="tea">
        <h2 data-i18n="adv_tea_title">标准因子 API (TEA_*)</h2>
        <p data-i18n="adv_tea_p" data-i18n-html="1">以下为对接时实际调用的 API：创建因子、传入 K 线、取回方向/动作/置信度等。handle 在 MQ4 中为 <code>int</code>；数组顺序 <strong>下标 0 = 最旧一根 K 线，size-1 = 最新</strong>；<strong>必须先调用 Process 且返回 1，再调用 Get* 取信号</strong>，否则结果未定义。</p>

        <div class="api-block">
          <div class="api-name">TEA_FactorCreate</div>
          <div class="api-sig">int TEA_FactorCreate(int factorId);</div>
          <table>
            <thead><tr><th data-i18n="adv_param">入参</th><th data-i18n="adv_type">类型</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody><tr><td>factorId</td><td>int</td><td data-i18n="adv_tea_create_factorid_desc">因子 ID：0=EntropyHedge，1=TrendPenalty，2=HedgeRegime，3=TrendStrengthBrake。见上方类型与常量。</td></tr></tbody>
          </table>
          <table>
            <tr><th data-i18n="adv_ret_title">返回值</th><td class="ret">int</td><td data-i18n="adv_tea_create_ret">成功返回非 0 句柄，失败返回 0。MQ4 用 int 接收；OnInit 中若为 0 应返回 INIT_FAILED。</td></tr>
          </table>
        </div>

        <div class="api-block">
          <div class="api-name">TEA_FactorDestroy</div>
          <div class="api-sig">void TEA_FactorDestroy(int handle);</div>
          <table>
            <thead><tr><th data-i18n="adv_param">入参</th><th data-i18n="adv_type">类型</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody><tr><td>handle</td><td>int</td><td data-i18n="adv_tea_destroy_handle_desc">TEA_FactorCreate 返回的句柄。OnDeinit 中必须调用，且仅对非 0 句柄调用，避免重复释放。</td></tr></tbody>
          </table>
        </div>

        <div class="api-block">
          <div class="api-name">TEA_FactorProcess</div>
          <div class="api-sig">int TEA_FactorProcess(int handle, double &opens[], double &highs[], double &lows[], double &closes[], double &volumes[], int size);</div>
          <table>
            <thead><tr><th data-i18n="adv_param">入参</th><th data-i18n="adv_type">类型</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody>
              <tr><td>handle</td><td>int</td><td data-i18n="adv_tea_process_handle_desc">因子句柄，非 0。</td></tr>
              <tr><td>opens, highs, lows, closes, volumes</td><td>double[]</td><td data-i18n="adv_tea_process_ohlcv_desc">开盘、最高、最低、收盘、成交量数组。<strong>顺序：下标 0 = 最旧 K 线，size-1 = 最新</strong>；与 MT 的 CopyOpen 等顺序一致（时间升序）。</td></tr>
              <tr><td>size</td><td>int</td><td data-i18n="adv_tea_process_size_desc">数组长度，<strong>至少 50</strong>，建议 200。五组数组长度必须一致。</td></tr>
            </tbody>
          </table>
          <table>
            <tr><th data-i18n="adv_ret_title">返回值</th><td class="ret">int</td><td data-i18n="adv_tea_process_ret">1=成功，0=失败。<strong>仅当返回 1 时方可调用 GetDirection/GetAction 等</strong>；否则不要读取信号。</td></tr>
          </table>
        </div>

        <div class="api-block">
          <div class="api-name">TEA_FactorGetDirection / TEA_FactorGetAction / TEA_FactorGetRegime</div>
          <div class="api-sig">double TEA_FactorGetDirection(int handle);</div>
          <div class="api-sig">int TEA_FactorGetAction(int handle);</div>
          <div class="api-sig">int TEA_FactorGetRegime(int handle);</div>
          <table>
            <thead><tr><th data-i18n="adv_param">入参</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody><tr><td>handle</td><td data-i18n="adv_tea_get_handle_desc">同上，且必须在本 tick 已成功调用过 TEA_FactorProcess(handle, ...) 且返回 1。</td></tr></tbody>
          </table>
          <table>
            <thead><tr><th data-i18n="adv_ret_title">返回值</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody>
              <tr><td>GetDirection</td><td data-i18n="adv_tea_get_dir_desc">double：-1.0=偏空，0=中性，+1.0=偏多。用于过滤或仓位方向。</td></tr>
              <tr><td>GetAction</td><td data-i18n="adv_tea_get_act_desc">int：0=FLAT（观望），1=LONG（做多），2=SHORT（做空）。直接用于开平仓判断。</td></tr>
              <tr><td>GetRegime</td><td data-i18n="adv_tea_get_regime_desc">int：1=趋势，2=震荡，-1=高风险。可用于减仓或刹车逻辑。</td></tr>
            </tbody>
          </table>
        </div>

        <h3 id="get-others" data-i18n="adv_get_others_title">其余 Get* API（信号与风控）</h3>
        <p data-i18n="adv_get_others_intro">以下 API 与 GetDirection/GetAction/GetRegime 调用约定相同：<strong>必须先在本 tick 调用 TEA_FactorProcess 且返回 1，再调用下列 Get*</strong>；否则返回值未定义。入参均为 <code>int handle</code>（因子句柄），下表仅列出返回值类型与含义。</p>
        <table>
          <thead><tr><th>API</th><th>签名</th><th data-i18n="table_usage">返回值 / 说明</th></tr></thead>
          <tbody>
            <tr><td><code>TEA_FactorGetConfidence</code></td><td><code>double TEA_FactorGetConfidence(int handle);</code></td><td data-i18n="adv_get_confidence_desc">double，0～1。信号置信度，常用于过滤：仅当 confidence &gt; 某阈值时开仓，或传入削单接口 <code>TEA_ReductionRecommend</code> 的 confidence 参数。</td></tr>
            <tr><td><code>TEA_FactorGetStrength</code></td><td><code>double TEA_FactorGetStrength(int handle);</code></td><td data-i18n="adv_get_strength_desc">double，0～1。信号强度，可用于仓位权重或过滤弱信号。</td></tr>
            <tr><td><code>TEA_FactorGetScore</code></td><td><code>double TEA_FactorGetScore(int handle);</code></td><td data-i18n="adv_get_score_desc">double，0～1。综合评分，与标准信号结构中的 <code>score</code> 一致，用于排序或过滤。</td></tr>
            <tr><td><code>TEA_FactorIsValid</code></td><td><code>int TEA_FactorIsValid(int handle);</code></td><td data-i18n="adv_get_isvalid_desc">int：1=有效，0=无效。<strong>深度集成时建议必读</strong>：仅在返回 1 时依据 Action/Direction 开仓，否则本 tick 不交易，避免在无效信号上下单。</td></tr>
            <tr><td><code>TEA_FactorGetAccuracyScore</code></td><td><code>int TEA_FactorGetAccuracyScore(int handle);</code></td><td data-i18n="adv_get_accuracy_desc">int，0～100。准确度/质量分，与标准信号结构 <code>accuracy_score</code> 一致，可用于多因子加权或风控阈值。</td></tr>
            <tr><td><code>TEA_FactorGetStopLoss</code></td><td><code>double TEA_FactorGetStopLoss(int handle);</code></td><td data-i18n="adv_get_sl_desc">double。因子建议的止损价；0 表示本因子不提供止损，需自行计算或使用其他逻辑。</td></tr>
            <tr><td><code>TEA_FactorGetTakeProfit</code></td><td><code>double TEA_FactorGetTakeProfit(int handle);</code></td><td data-i18n="adv_get_tp_desc">double。因子建议的止盈价；0 表示本因子不提供止盈。</td></tr>
            <tr><td><code>TEA_FactorGetBrake</code></td><td><code>int TEA_FactorGetBrake(int handle);</code></td><td data-i18n="adv_get_brake_desc">int：0 或 1。<strong>仅 HedgeRegime 因子</strong>：刹车标志，1=当前建议刹车（减仓/观望），可用于对冲 EA 的减仓或暂停加仓逻辑。</td></tr>
            <tr><td><code>TEA_FactorGetATR</code></td><td><code>double TEA_FactorGetATR(int handle);</code></td><td data-i18n="adv_get_atr_desc">double。<strong>仅 HedgeRegime 因子</strong>：内部使用的 ATR 值，可用于与自算 ATR 对比或风控参考。</td></tr>
            <tr><td><code>TEA_FactorGetBrakeStrength</code></td><td><code>double TEA_FactorGetBrakeStrength(int handle);</code></td><td data-i18n="adv_get_brakestrength_desc">double，0～1。<strong>仅 TrendStrengthBrake 因子</strong>：刹车强度，用于多周期 R²·刹车类策略的仓位或风控。</td></tr>
          </tbody>
        </table>
        <p class="note" data-i18n="adv_tea_note_usage"><strong>常见用法</strong>：开仓前可组合判断，例如 <code>if (TEA_FactorProcess(g_h, ...) == 1 && TEA_FactorIsValid(g_h) == 1 && TEA_FactorGetConfidence(g_h) >= 0.6) { ... }</code> 再根据 GetAction 下单；若使用因子建议止损止盈，则读取 GetStopLoss/GetTakeProfit，为 0 时忽略。</p>

        <h3 data-i18n="adv_code_mq4_title">MQ4 对接代码片段（可直接复用）</h3>
        <div class="api-example">
          <div class="copy-wrap">
            <pre data-lang="zh"><code class="language-cpp" id="code-adv-mq4-1">#include &lt;TraderEdgAIFactor.mqh&gt;
int g_h = 0;   // 因子句柄，全局保存

int OnInit() {
  g_h = TEA_FactorCreate(2);   // 2=HedgeRegime，可选 0/1/3
  if (g_h == 0) { Print("TEA: 因子创建失败"); return INIT_FAILED; }
  return INIT_SUCCEEDED;
}

void OnDeinit(int reason) {
  if (g_h != 0) { TEA_FactorDestroy(g_h); g_h = 0; }  // 仅对非 0 释放
}

void OnTick() {
  if (g_h == 0) return;

  // 准备 K 线：下标 0=最旧，n-1=最新，与 iOpen(..., bar) 顺序一致
  double o[], h[], l[], c[], v[];
  int n = 200;
  ArrayResize(o, n); ArrayResize(h, n); ArrayResize(l, n);
  ArrayResize(c, n); ArrayResize(v, n);
  for (int i = 0; i < n; i++) {
    int bar = n - 1 - i;
    o[i] = iOpen(Symbol(), PERIOD_CURRENT, bar);
    h[i] = iHigh(Symbol(), PERIOD_CURRENT, bar);
    l[i] = iLow(Symbol(), PERIOD_CURRENT, bar);
    c[i] = iClose(Symbol(), PERIOD_CURRENT, bar);
    v[i] = (double)iVolume(Symbol(), PERIOD_CURRENT, bar);
  }

  if (TEA_FactorProcess(g_h, o, h, l, c, v, n) != 1) return;  // 失败则不读信号

  double dir = TEA_FactorGetDirection(g_h);
  int act = TEA_FactorGetAction(g_h);
  int regime = TEA_FactorGetRegime(g_h);
  // 使用 dir / act / regime 做开平仓逻辑
}</code></pre>
            <pre data-lang="en" style="display:none"><code class="language-cpp" id="code-adv-mq4-1-en">#include &lt;TraderEdgAIFactor.mqh&gt;
int g_h = 0;   // factor handle, global

int OnInit() {
  g_h = TEA_FactorCreate(2);   // 2=HedgeRegime, or 0/1/3
  if (g_h == 0) { Print("TEA: factor create failed"); return INIT_FAILED; }
  return INIT_SUCCEEDED;
}

void OnDeinit(int reason) {
  if (g_h != 0) { TEA_FactorDestroy(g_h); g_h = 0; }  // only free non-zero
}

void OnTick() {
  if (g_h == 0) return;

  // OHLCV: index 0=oldest, n-1=newest, same order as iOpen(..., bar)
  double o[], h[], l[], c[], v[];
  int n = 200;
  ArrayResize(o, n); ArrayResize(h, n); ArrayResize(l, n);
  ArrayResize(c, n); ArrayResize(v, n);
  for (int i = 0; i < n; i++) {
    int bar = n - 1 - i;
    o[i] = iOpen(Symbol(), PERIOD_CURRENT, bar);
    h[i] = iHigh(Symbol(), PERIOD_CURRENT, bar);
    l[i] = iLow(Symbol(), PERIOD_CURRENT, bar);
    c[i] = iClose(Symbol(), PERIOD_CURRENT, bar);
    v[i] = (double)iVolume(Symbol(), PERIOD_CURRENT, bar);
  }

  if (TEA_FactorProcess(g_h, o, h, l, c, v, n) != 1) return;  // do not read signals on failure

  double dir = TEA_FactorGetDirection(g_h);
  int act = TEA_FactorGetAction(g_h);
  int regime = TEA_FactorGetRegime(g_h);
  // use dir / act / regime for open/close logic
}</code></pre>
            <button type="button" class="api-copy-btn" data-copy="code-adv-mq4-1" data-copy-en="code-adv-mq4-1-en" data-i18n="copy_btn">复制</button>
          </div>
        </div>

        <h3 data-i18n="adv_code_mq5_title">MQ5 对接代码片段（可直接复用）</h3>
        <div class="api-example">
          <div class="copy-wrap">
            <pre data-lang="zh"><code class="language-cpp" id="code-adv-mq5-1">#include &lt;TraderEdgAIFactor.mqh&gt;
int g_h = 0;

int OnInit() {
  g_h = TEA_FactorCreate(TEA_FACTOR_HEDGE_REGIME);  // 2
  if (g_h == 0) { Print("TEA: 因子创建失败"); return INIT_FAILED; }
  return INIT_SUCCEEDED;
}

void OnDeinit(const int reason) {
  if (g_h != 0) { TEA_FactorDestroy(g_h); g_h = 0; }
}

void OnTick() {
  if (g_h == 0) return;

  MqlRates rates[];
  int n = 200;
  if (CopyRates(_Symbol, PERIOD_CURRENT, 0, n, rates) != n) return;  // 0=最旧，n-1=最新

  double o[], h[], l[], c[], v[];
  ArrayResize(o, n); ArrayResize(h, n); ArrayResize(l, n); ArrayResize(c, n); ArrayResize(v, n);
  for (int i = 0; i < n; i++) {
    o[i] = rates[i].open;   h[i] = rates[i].high;
    l[i] = rates[i].low;    c[i] = rates[i].close;
    v[i] = (double)rates[i].tick_volume;
  }

  if (TEA_FactorProcess(g_h, o, h, l, c, v, n) != 1) return;

  double dir = TEA_FactorGetDirection(g_h);
  int act = TEA_FactorGetAction(g_h);
  int regime = TEA_FactorGetRegime(g_h);
}</code></pre>
            <pre data-lang="en" style="display:none"><code class="language-cpp" id="code-adv-mq5-1-en">#include &lt;TraderEdgAIFactor.mqh&gt;
int g_h = 0;

int OnInit() {
  g_h = TEA_FactorCreate(TEA_FACTOR_HEDGE_REGIME);  // 2
  if (g_h == 0) { Print("TEA: factor create failed"); return INIT_FAILED; }
  return INIT_SUCCEEDED;
}

void OnDeinit(const int reason) {
  if (g_h != 0) { TEA_FactorDestroy(g_h); g_h = 0; }
}

void OnTick() {
  if (g_h == 0) return;

  MqlRates rates[];
  int n = 200;
  if (CopyRates(_Symbol, PERIOD_CURRENT, 0, n, rates) != n) return;  // 0=oldest, n-1=newest

  double o[], h[], l[], c[], v[];
  ArrayResize(o, n); ArrayResize(h, n); ArrayResize(l, n); ArrayResize(c, n); ArrayResize(v, n);
  for (int i = 0; i < n; i++) {
    o[i] = rates[i].open;   h[i] = rates[i].high;
    l[i] = rates[i].low;    c[i] = rates[i].close;
    v[i] = (double)rates[i].tick_volume;
  }

  if (TEA_FactorProcess(g_h, o, h, l, c, v, n) != 1) return;

  double dir = TEA_FactorGetDirection(g_h);
  int act = TEA_FactorGetAction(g_h);
  int regime = TEA_FactorGetRegime(g_h);
}</code></pre>
            <button type="button" class="api-copy-btn" data-copy="code-adv-mq5-1" data-copy-en="code-adv-mq5-1-en" data-i18n="copy_btn">复制</button>
          </div>
        </div>

        <p class="note" data-i18n="adv_faq_tea"><strong>常见问题</strong>：① 数组顺序反了会导致信号错误，务必 0=最旧；传入 Process 的 K 线数组<strong>不要</strong>使用 <code>ArraySetAsSeries(true)</code>，否则顺序会反。② Process 返回 0 时不要调用 Get*。③ handle 为 0 时不要调用任何接口。④ OnDeinit 里只对非 0 handle 调用 Destroy。</p>
      </section>

      <!-- 削单 API：入参/出参/说明 + 代码片段 -->
      <section class="sec" id="reduction">
        <h2 data-i18n="adv_reduction_title">削单 API · TEA_ReductionRecommend</h2>
        <p data-i18n="adv_reduction_intro" data-i18n-html="1">无状态接口：每次传入多空两侧持仓的盈亏、手数、开仓时间等数组及少量控制参数，返回本 tick 是否建议削单及削哪一侧、先平盈利再平亏损。适合对冲/马丁 EA 的减仓决策。详见 <a href="factors.html">算法因子库</a> ReductionAdvisor。</p>

        <div class="api-block">
          <div class="api-name">TEA_ReductionRecommend</div>
          <div class="api-sig">int TEA_ReductionRecommend(double &profit_buy[], double &lots_buy[], int &open_time_buy[], int count_buy, double &profit_sell[], double &lots_sell[], int &open_time_sell[], int count_sell, int regime, double confidence, double target_net, int max_tail_count, double min_margin_base, int allow_cross_side, int risk_mode, int &out_action, int &out_side, int &out_loss_index, int &out_profit_start_index, int &out_profit_count, int &out_segment_side, int &out_cross_side, double &out_net_profit, double &out_reduction_potential, double &out_estimated_float_reduction, int &out_strategy_used);</div>

          <h4 data-i18n="adv_reduction_in_title">入参说明</h4>
          <table>
            <thead><tr><th data-i18n="adv_param_title">参数</th><th data-i18n="adv_type">类型</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody>
              <tr><td>profit_buy[], lots_buy[], open_time_buy[]</td><td>数组</td><td data-i18n="adv_reduction_in_buy_desc">多侧每笔持仓的<strong>浮动盈亏</strong>、<strong>手数</strong>、<strong>开仓时间</strong>（Unix 或 MQL 时间）。<strong>必须按开仓时间升序</strong>排列。</td></tr>
              <tr><td>count_buy</td><td>int</td><td data-i18n="adv_reduction_in_count_buy">多侧持仓笔数，与上面三个数组长度一致。</td></tr>
              <tr><td>profit_sell[], lots_sell[], open_time_sell[]</td><td>数组</td><td data-i18n="adv_reduction_in_sell_desc">空侧同上，按开仓时间升序。</td></tr>
              <tr><td>count_sell</td><td>int</td><td data-i18n="adv_reduction_in_count_sell">空侧持仓笔数。</td></tr>
              <tr><td>regime</td><td>int</td><td data-i18n="adv_reduction_in_regime">市场状态：1=趋势，2=震荡，-1=高风险。可与 TEA_FactorGetRegime 一致。</td></tr>
              <tr><td>confidence</td><td>double</td><td data-i18n="adv_reduction_in_confidence">置信度 0～1。</td></tr>
              <tr><td>target_net</td><td>double</td><td data-i18n="adv_reduction_in_target_net">目标净利，可传 0。</td></tr>
              <tr><td>max_tail_count</td><td>int</td><td data-i18n="adv_reduction_in_max_tail">尾端（亏损段）最多保留笔数。</td></tr>
              <tr><td>min_margin_base</td><td>double</td><td data-i18n="adv_reduction_in_min_margin">最小保证金基数，可传 0。</td></tr>
              <tr><td>allow_cross_side</td><td>int</td><td data-i18n="adv_reduction_in_allow_cross">是否允许跨侧削单：0=否，1=是。</td></tr>
              <tr><td>risk_mode</td><td>int</td><td data-i18n="adv_reduction_in_risk_mode">风控模式，见头文件常量。</td></tr>
            </tbody>
          </table>

          <h4 data-i18n="adv_reduction_out_title">出参说明（DLL 写回，调用前需声明变量）</h4>
          <table>
            <thead><tr><th data-i18n="adv_param_title">参数</th><th data-i18n="adv_type">类型</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody>
              <tr><td>out_action</td><td>int &</td><td data-i18n="adv_reduction_out_action">1=单侧削多，2=单侧削空，3=跨侧削单。</td></tr>
              <tr><td>out_side</td><td>int &</td><td data-i18n="adv_reduction_out_side">亏损侧。</td></tr>
              <tr><td>out_loss_index</td><td>int &</td><td data-i18n="adv_reduction_out_loss_idx">亏损单索引。</td></tr>
              <tr><td>out_profit_start_index</td><td>int &</td><td data-i18n="adv_reduction_out_profit_start">盈利段起始索引（先平这部分）。</td></tr>
              <tr><td>out_profit_count</td><td>int &</td><td data-i18n="adv_reduction_out_profit_count">盈利段笔数。执行顺序：先平盈利段 [start_index, start_index+count)，再平亏损。</td></tr>
              <tr><td>out_segment_side, out_cross_side</td><td>int &</td><td data-i18n="adv_reduction_out_seg_cross">段侧、是否跨侧，见头文件。</td></tr>
              <tr><td>out_net_profit, out_reduction_potential, out_estimated_float_reduction</td><td>double &</td><td data-i18n="adv_reduction_out_net_etc">净利、削单潜能等，按需使用。</td></tr>
              <tr><td>out_strategy_used</td><td>int &</td><td data-i18n="adv_reduction_out_strategy">本次使用的策略标识。</td></tr>
            </tbody>
          </table>

          <table>
            <tr><th data-i18n="adv_ret_title">返回值</th><td class="ret">int</td><td data-i18n="adv_reduction_ret">1=本 tick 有削单推荐，可按 out_* 执行平仓；0=无推荐。</td></tr>
          </table>
        </div>

        <h3 data-i18n="adv_reduction_code_title">MQ4 对接代码片段（声明出参变量后调用）</h3>
        <div class="api-example">
          <div class="copy-wrap">
            <pre data-lang="zh"><code class="language-cpp" id="code-adv-reduction">// 1. 准备多空两侧数组：按开仓时间升序填充 profit_buy[], lots_buy[], open_time_buy[] 与 sell 侧
// 2. 取得 regime、confidence（例如从 TEA_FactorGetRegime/GetConfidence）
int regime = 1;
double confidence = 0.7;

// 3. 声明所有出参变量（MQ4 中通过引用传回）
int out_act, out_side, out_loss_idx, out_profit_start, out_profit_cnt;
int out_seg_side, out_cross_side, out_strategy;
double out_net, out_potential, out_float_red;

// 4. 调用（数组与 count 必须对应）
int hasRec = TEA_ReductionRecommend(
  profit_buy, lots_buy, open_time_buy, count_buy,
  profit_sell, lots_sell, open_time_sell, count_sell,
  regime, confidence, 0.0, 3, 0.0, 1, 0,
  out_act, out_side, out_loss_idx, out_profit_start, out_profit_cnt,
  out_seg_side, out_cross_side,
  out_net, out_potential, out_float_red, out_strategy
);

if (hasRec == 1) {
  // 有推荐：先平盈利段（从 out_profit_start 起共 out_profit_cnt 笔），再平亏损单
  // 根据 out_act/out_side 判断是单侧还是跨侧
}</code></pre>
            <pre data-lang="en" style="display:none"><code class="language-cpp" id="code-adv-reduction-en">// 1. Prepare buy/sell arrays: fill profit_buy[], lots_buy[], open_time_buy[] and sell side, ascending by open time
// 2. Get regime, confidence (e.g. from TEA_FactorGetRegime/GetConfidence)
int regime = 1;
double confidence = 0.7;

// 3. Declare all output vars (MQ4 passes by reference)
int out_act, out_side, out_loss_idx, out_profit_start, out_profit_cnt;
int out_seg_side, out_cross_side, out_strategy;
double out_net, out_potential, out_float_red;

// 4. Call (array lengths must match count)
int hasRec = TEA_ReductionRecommend(
  profit_buy, lots_buy, open_time_buy, count_buy,
  profit_sell, lots_sell, open_time_sell, count_sell,
  regime, confidence, 0.0, 3, 0.0, 1, 0,
  out_act, out_side, out_loss_idx, out_profit_start, out_profit_cnt,
  out_seg_side, out_cross_side,
  out_net, out_potential, out_float_red, out_strategy
);

if (hasRec == 1) {
  // Has recommendation: close profit segment first (from out_profit_start, out_profit_cnt bars), then loss
  // Use out_act/out_side to tell single-side vs cross-side
}</code></pre>
            <button type="button" class="api-copy-btn" data-copy="code-adv-reduction" data-copy-en="code-adv-reduction-en" data-i18n="copy_btn">复制</button>
          </div>
        </div>

        <p class="note" data-i18n="adv_reduction_faq"><strong>常见问题</strong>：① 多空数组必须按<strong>开仓时间升序</strong>，否则推荐结果可能错误。② 出参必须提前声明变量，MQ4 中通过引用传回。③ 先平盈利再平亏损。④ allow_cross_side=0 时不会返回跨侧建议。完整签名以 <code>TraderEdgAIFactor.mqh</code> 为准。</p>
      </section>

      <!-- R² API：入参/出参/说明 + 代码片段 -->
      <section class="sec" id="rsquared">
        <h2 data-i18n="adv_rsquared_title">R² API · TEA_RSquared / TEA_RSquaredEx</h2>
        <p data-i18n="adv_rsquared_intro" data-i18n-html="1">无状态接口：传入收盘价数组与长度，返回 0～1 的趋势强度 R²。用于替代手写 R²，数值稳定、抗异常值。详见 <a href="factors.html">算法因子库</a> RSquared。</p>

        <div class="api-block">
          <div class="api-name">TEA_RSquared</div>
          <div class="api-sig">double TEA_RSquared(double &closes[], int count);</div>
          <table>
            <thead><tr><th data-i18n="adv_param">入参</th><th data-i18n="adv_type">类型</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody>
              <tr><td>closes[]</td><td>double[]</td><td data-i18n="adv_rsquared_in_closes">收盘价数组。<strong>下标 0 = 最旧 K 线，count-1 = 最新</strong>（时间升序）。</td></tr>
              <tr><td>count</td><td>int</td><td data-i18n="adv_rsquared_in_count">数组长度，即计算 R² 的 K 线根数。<strong>建议 2～512</strong>；count&lt;2 时返回 0。</td></tr>
            </tbody>
          </table>
          <table>
            <tr><th data-i18n="adv_ret_title">返回值</th><td class="ret">double</td><td data-i18n="adv_rsquared_ret">0～1，越接近 1 趋势越强，接近 0 表示无明显趋势。</td></tr>
          </table>
        </div>

        <div class="api-block">
          <div class="api-name">TEA_RSquaredEx</div>
          <div class="api-sig">double TEA_RSquaredEx(double &closes[], int count, int mode, double &out_slope);</div>
          <table>
            <thead><tr><th data-i18n="adv_param">入参</th><th data-i18n="adv_type">类型</th><th data-i18n="adv_desc">说明</th></tr></thead>
            <tbody>
              <tr><td>closes[], count</td><td data-i18n="adv_rsquared_ex_same">同上</td><td data-i18n="adv_rsquared_ex_same_desc">同上。</td></tr>
              <tr><td>mode</td><td>int</td><td data-i18n="adv_rsquared_ex_mode">0=Pearson（数值稳定），1=Theil-Sen 稳健，2=指数加权。</td></tr>
              <tr><td>out_slope</td><td>double &</td><td data-i18n="adv_rsquared_ex_out_slope">可选，非 NULL 时写回拟合斜率。</td></tr>
            </tbody>
          </table>
          <table>
            <tr><th data-i18n="adv_ret_title">返回值</th><td class="ret">double</td><td data-i18n="adv_rsquared_ret">0～1，同上。</td></tr>
          </table>
        </div>

        <h3 data-i18n="adv_rsquared_code_mq4_title">MQ4 对接代码片段</h3>
        <div class="api-example">
          <div class="copy-wrap">
            <pre data-lang="zh"><code class="language-cpp" id="code-adv-r2-mq4">double closes[];
int n = 100;
ArrayResize(closes, n);
CopyClose(Symbol(), PERIOD_CURRENT, 0, n, closes);  // 0=最旧，n-1=最新
double r2 = TEA_RSquared(closes, n);
// r2 在 0～1，可用于过滤或仓位权重</code></pre>
            <pre data-lang="en" style="display:none"><code class="language-cpp" id="code-adv-r2-mq4-en">double closes[];
int n = 100;
ArrayResize(closes, n);
CopyClose(Symbol(), PERIOD_CURRENT, 0, n, closes);  // 0=oldest, n-1=newest
double r2 = TEA_RSquared(closes, n);
// r2 in 0~1; use for filter or position weight</code></pre>
            <button type="button" class="api-copy-btn" data-copy="code-adv-r2-mq4" data-copy-en="code-adv-r2-mq4-en" data-i18n="copy_btn">复制</button>
          </div>
        </div>

        <h3 data-i18n="adv_rsquared_code_mq5_title">MQ5 对接代码片段</h3>
        <div class="api-example">
          <div class="copy-wrap">
            <pre data-lang="zh"><code class="language-cpp" id="code-adv-r2-mq5">double closes[];
int n = 100;
if (CopyClose(_Symbol, PERIOD_CURRENT, 0, n, closes) != n) return;
double r2 = TEA_RSquared(closes, n);</code></pre>
            <pre data-lang="en" style="display:none"><code class="language-cpp" id="code-adv-r2-mq5-en">double closes[];
int n = 100;
if (CopyClose(_Symbol, PERIOD_CURRENT, 0, n, closes) != n) return;
double r2 = TEA_RSquared(closes, n);</code></pre>
            <button type="button" class="api-copy-btn" data-copy="code-adv-r2-mq5" data-copy-en="code-adv-r2-mq5-en" data-i18n="copy_btn">复制</button>
          </div>
        </div>

        <p class="note" data-i18n="adv_rsquared_faq"><strong>常见问题</strong>：① 数组顺序必须 0=最旧，否则 R² 含义错误。② count&lt;2 返回 0。③ 需 Theil-Sen 或指数加权时用 TEA_RSquaredEx(closes, n, mode, out_slope)。</p>
      </section>

      <p class="note" style="margin-top: 2rem;" data-i18n="doc_note_footer">文档随 TraderEdgAIFactor 源码维护，若 DLL 版本更新请以实际导出与行为为准。</p>
    </main>
  </div>

  <script>
    (function () {
      var toc = document.querySelector('.api-toc');
      var links = toc ? toc.querySelectorAll('a[href^="#"]') : [];
      var sections = [];
      links.forEach(function (a) {
        var id = a.getAttribute('href').slice(1);
        var el = document.getElementById(id);
        if (el) sections.push({ id: id, el: el, a: a });
      });
      function updateActive() {
        var top = window.scrollY + 80;
        for (var i = sections.length - 1; i >= 0; i--) {
          var s = sections[i];
          if (s.el.getBoundingClientRect().top + window.scrollY <= top) {
            links.forEach(function (l) { l.classList.remove('active'); });
            s.a.classList.add('active');
            return;
          }
        }
        if (sections.length) links.forEach(function (l) { l.classList.remove('active'); });
      }
      window.addEventListener('scroll', updateActive);
      window.addEventListener('load', updateActive);
    })();
  </script>

  <footer>
    <div class="footer-inner">
      <div class="footer-links">
        <a href="index.html">TraderEdgeAIFactor</a>
        <a href="releases/v1.0/mql4-include.zip" download data-i18n="footer_download">下载</a>
        <a href="index.html#how" data-i18n="footer_how">极速上手</a>
        <a href="api.html" data-i18n="footer_api">API 文档</a>
        <a href="api-advanced.html" data-i18n="footer_advanced">进阶版</a>
        <a href="index.html#pricing" data-i18n="footer_pricing">定价</a>
        <a href="index.html#faq" data-i18n="footer_faq">常见问题</a>
      </div>
      <p class="footer-copy" data-i18n="footer_copy">© TraderEdgeAI.com 使用前请阅读授权与免责声明。</p>
    </div>
  </footer>

  <script src="js/i18n.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-cpp.min.js"></script>
  <script>
    (function () {
      var lang = window.I18N ? window.I18N.getLang() : 'zh';
      if (window.I18N) window.I18N.applyLang(lang, 'api');
      if (window.Prism) window.Prism.highlightAll();
      document.querySelectorAll('.nav-lang .lang-btn').forEach(function (btn) {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
      });
      document.querySelectorAll('.nav-lang .lang-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var l = btn.getAttribute('data-lang');
          if (window.I18N) { window.I18N.setLang(l); window.I18N.applyLang(l, 'api'); }
          document.querySelectorAll('.nav-lang .lang-btn').forEach(function (b) { b.classList.remove('active'); });
          btn.classList.add('active');
          if (window.Prism) window.Prism.highlightAll();
        });
      });
    })();
    (function () {
      document.querySelectorAll('.api-copy-btn[data-copy]').forEach(function (btn) {
        btn.addEventListener('click', function () {
          var lang = window.I18N && window.I18N.getLang ? window.I18N.getLang() : 'zh';
          var id = (lang === 'en' && btn.getAttribute('data-copy-en')) ? btn.getAttribute('data-copy-en') : btn.getAttribute('data-copy');
          var el = id ? document.getElementById(id) : null;
          if (!el) return;
          var text = el.textContent || '';
          var t = window.I18N && window.I18N.LANG && window.I18N.LANG.api && window.I18N.LANG.api[window.I18N.getLang()];
          var copyDone = t && t.copy_done ? t.copy_done : '已复制';
          var copyBtn = t && t.copy_btn ? t.copy_btn : '复制';
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function () {
              btn.textContent = copyDone;
              btn.classList.add('copied');
              setTimeout(function () { btn.textContent = copyBtn; btn.classList.remove('copied'); }, 2000);
            });
          } else {
            var ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            btn.textContent = copyDone;
            btn.classList.add('copied');
            setTimeout(function () { btn.textContent = copyBtn; btn.classList.remove('copied'); }, 2000);
          }
        });
      });
    })();
    (function () {
      var nav = document.getElementById('main-nav');
      var toggle = document.getElementById('nav-toggle');
      if (nav && toggle) toggle.addEventListener('click', function () { nav.classList.toggle('nav-open'); });
    })();
  </script>
</body>

</html>
